<!DOCTYPE html>
<html>
	<head>
	<meta charset="utf-8" />
	<title>index</title>
	<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
	<!-- Leaflet CDN -->
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
	<!--[if lte IE 8]>
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.ie.css" />
	<![endif]-->

	<script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>


	<style>
		/* Define height for map section */
		#map {
			margin-top: 40px;
			height: 600px;
		}
	</style>

</head>
<body>
	<div id="map"></div>

	<script type="text/javascript">
		// initialize the map...
		var map = L.map('map').setView([46.7, 4.19], 5);

		// ... load tile layer ...
		L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
		attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
		}).addTo(map);

		function addToMap(stations) {
			for (n in stations) {
				var s = stations[n];
				stations[n]['marker'] = L.marker(s['coords']).addTo(map).bindPopup('<h4>'+s['name']+'</h4>');
			}
		}

		function updateAll(stations) {

			for (n in stations) {
				$.getJSON(base_url+"/stations/"+n+"/"+ligne+"?callback=?", null, function(a){
					var code = parseInt(a.station);
					if (a.stops[0] == "maintenant") { markToShow = stations[code].marker}
					stations[code].marker.unbindPopup();
					stations[code].marker
						.bindPopup('<h4>'+stations[code].name+'</h4><p>Prochain passage :'+a.stops[0]+'</p>')
						.openPopup().closePopup();
				});
			}
		}

		// get data from API
		var stations;
		var markToShow;
		var base_url = "http://timeoapi.haum.org/v1";
		var ligne="9_R";
		var url =  base_url+"/lines/"+ligne;
		$.getJSON(url + "?callback=?", null, function(a) {
			stations = a['stations'];
			addToMap(stations);
			updateAll(stations);
		});

		// }, 60000);



	</script>

</body>
</html>
